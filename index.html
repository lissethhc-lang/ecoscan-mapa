<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script>
    // ConfiguraciÃ³n de Firebase
    const firebaseConfig = {
        databaseURL: "https://ecoscan-tupac-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // INICIALIZACIÃ“N CRÃTICA: Aseguramos que el mapa se inicie primero
    const mapa = L.map('mapa').setView([-6.7067, -79.9067], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(mapa);

    let marcadores = [];
    let todosLosReportes = [];

    const iconoPlastico = L.divIcon({
        html: '<div style="background: #dc3545; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ”´</div>',
        className: '',
        iconSize: [30, 30]
    });

    const iconoNoPlastico = L.divIcon({
        html: '<div style="background: #28a745; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸŸ¢</div>',
        className: '',
        iconSize: [30, 30]
    });

    // FunciÃ³n auxiliar para normalizar texto (la clave para el Ã©xito)
    function normalizarEtiqueta(etiqueta) {
        if (!etiqueta) return '';
        // Convierte a minÃºsculas y elimina espacios o guiones bajos
        return String(etiqueta).toLowerCase().replace(/[_\s]/g, '');
    }

    // FUNCIÃ“N DE FECHA SIMPLIFICADA (EVITA FALLOS)
    function formatearFecha(timestamp) {
        let fechaObj;
        if (typeof timestamp === 'string' && timestamp.length === 15 && timestamp.includes('_')) {
             // Formato de App Inventor: YYYYMMDD_HHMMSS
             const year = timestamp.substring(0, 4);
             const month = timestamp.substring(4, 6);
             const day = timestamp.substring(6, 8);
             const hour = timestamp.substring(9, 11);
             const minute = timestamp.substring(11, 13);
             const second = timestamp.substring(13, 15);
             
             // Creamos un string de fecha compatible: YYYY-MM-DDTHH:MM:SS
             fechaObj = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`);

        } else if (typeof timestamp === 'number') {
            fechaObj = new Date(timestamp);
        } else {
            return "Fecha desconocida";
        }

        return fechaObj.toLocaleString('es-PE', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }


    function cargarReportes() {
        document.getElementById('loading').style.display = 'block';

        database.ref('reports').on('value', (snapshot) => { 
            const datos = snapshot.val();
            
            if (!datos) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('contenido').style.display = 'block';
                document.getElementById('contador').textContent = 'No hay reportes';
                return;
            }

            marcadores.forEach(m => mapa.removeLayer(m));
            marcadores = [];
            todosLosReportes = [];

            for (let key in datos) {
                const reporte = datos[key];
                
                // USAMOS reporte.etiqueta (singular)
                const etiquetaNormalizada = normalizarEtiqueta(reporte.etiqueta); 
                
                todosLosReportes.push({ 
                    id: key, 
                    ...reporte,
                    // CORRECCIÃ“N: UNIFICAMOS LONGITUD A MINÃšSCULAS
                    longitud: reporte.Longitud || reporte.longitud || 0,
                    etiqueta_normalizada: etiquetaNormalizada 
                });
            }

            todosLosReportes.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            actualizarEstadisticas();
            mostrarReportesEnMapa(todosLosReportes);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('contenido').style.display = 'block';
        });
    }

    function actualizarEstadisticas() {
        const total = todosLosReportes.length;
        
        const plastico = todosLosReportes.filter(r => r.etiqueta_normalizada === 'plastico').length;
        const noPlastico = todosLosReportes.filter(r => r.etiqueta_normalizada === 'noplastico').length;

        document.getElementById('totalReportes').textContent = total;
        document.getElementById('totalPlastico').textContent = plastico;
        document.getElementById('totalNoPlastico').textContent = noPlastico;
        document.getElementById('contador').textContent = `${total} reporte${total !== 1 ? 's' : ''}`;
    }

    function mostrarReportesEnMapa(reportes) {
        reportes.forEach(reporte => {
            if (!reporte.latitud || !reporte.longitud) return;

            const esPlastico = reporte.etiqueta_normalizada === 'plastico'; 
            const icono = esPlastico ? iconoPlastico : iconoNoPlastico;

            const marcador = L.marker([reporte.latitud, reporte.longitud], { icon: icono }).addTo(mapa); 

            const fecha = formatearFecha(reporte.fecha || reporte.timestamp);
            
            const popupContent = `
                <div style="text-align: center;">
                    <img src="${reporte.foto_url || 'https://via.placeholder.com/200x150?text=Sin+foto'}" class="popup-imagen" alt="Foto del reporte" onerror="this.src='https://via.placeholder.com/200x150?text=Imagen+no+disponible'">
                    <h4>${esPlastico ? 'ğŸ”´ PlÃ¡stico' : 'ğŸŸ¢ No PlÃ¡stico'}</h4>
                    <p>ğŸ“… ${fecha}</p>
                    <p>ğŸ“ ${reporte.latitud.toFixed(5)}, ${reporte.longitud.toFixed(5)}</p>
                </div>
            `;
            
            marcador.bindPopup(popupContent);
            marcadores.push(marcador);
        });
        document.getElementById('contador').textContent = `${reportes.length} reporte${reportes.length !== 1 ? 's' : ''}`;
    }

    function filtrar(tipo) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        
        const botonClicado = document.querySelector(`[onclick="filtrar('${tipo}')"]`);
        if (botonClicado) {
            botonClicado.classList.add('active');
        }

        let reportesFiltrados = tipo === 'todos' 
            ? todosLosReportes 
            : todosLosReportes.filter(r => {
                const tipoNorm = normalizarEtiqueta(tipo);
                return r.etiqueta_normalizada === tipoNorm;
            });

        marcadores.forEach(m => mapa.removeLayer(m));
        marcadores = [];
        mostrarReportesEnMapa(reportesFiltrados);
    }

    // Iniciamos la carga de reportes al final
    cargarReportes();
</script>
