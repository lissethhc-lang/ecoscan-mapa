<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script>
    // Configuraci칩n de Firebase
    const firebaseConfig = {
        databaseURL: "https://ecoscan-tupac-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Inicializar mapa en Laguna, Per칰
    const mapa = L.map('mapa').setView([-6.7067, -79.9067], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '춸 OpenStreetMap contributors'
    }).addTo(mapa);

    let marcadores = [];
    let todosLosReportes = [];

    const iconoPlastico = L.divIcon({
        html: '<div style="background: #dc3545; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">游댮</div>',
        className: '',
        iconSize: [30, 30]
    });

    const iconoNoPlastico = L.divIcon({
        html: '<div style="background: #28a745; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">游릭</div>',
        className: '',
        iconSize: [30, 30]
    });

    // Funci칩n auxiliar para normalizar texto (la clave para el 칠xito)
    function normalizarEtiqueta(etiqueta) {
        if (!etiqueta) return '';
        // Convierte a min칰sculas y elimina espacios o guiones bajos
        return String(etiqueta).toLowerCase().replace(/[_\s]/g, '');
    }

    // Funci칩n auxiliar para formatear fecha (tomada de tu l칩gica anterior)
    function formatearFecha(timestamp) {
        // Asume que es un timestamp UNIX o el string de fecha 'YYYYMMDD_HHMMSS'
        let fechaObj;
        if (typeof timestamp === 'string' && timestamp.length === 15 && timestamp.includes('_')) {
             const parts = timestamp.split('_');
             const datePart = parts[0];
             const timePart = parts[1];
             // Formato: YYYY-MM-DDTHH:MM:SS
             fechaObj = new Date(
                 datePart.substring(0, 4), 
                 parseInt(datePart.substring(4, 6)) - 1, 
                 datePart.substring(6, 8), 
                 timePart.substring(0, 2), 
                 timePart.substring(2, 4), 
                 timePart.substring(4, 6)
             );
        } else {
            fechaObj = new Date(timestamp || 0);
        }

        return fechaObj.toLocaleString('es-PE', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }


    function cargarReportes() {
        database.ref('reports').on('value', (snapshot) => { 
            const datos = snapshot.val();
            
            if (!datos) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('contenido').style.display = 'block';
                document.getElementById('contador').textContent = 'No hay reportes';
                return;
            }

            marcadores.forEach(m => mapa.removeLayer(m));
            marcadores = [];
            todosLosReportes = [];

            for (let key in datos) {
                const reporte = datos[key];
                
                // USAMOS reporte.etiqueta (singular) Y LO NORMALIZAMOS
                const etiquetaNormalizada = normalizarEtiqueta(reporte.etiqueta); 
                
                // Creamos un reporte unificado con claves consistentes
                todosLosReportes.push({ 
                    id: key, 
                    ...reporte,
                    // Aseguramos que la Longitud se lea con L may칰scula y la guardamos en min칰scula
                    longitud: reporte.Longitud || reporte.longitud || 0,
                    // Clave unificada para toda la l칩gica
                    etiqueta_normalizada: etiquetaNormalizada 
                });
            }

            todosLosReportes.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            actualizarEstadisticas();
            mostrarReportesEnMapa(todosLosReportes);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('contenido').style.display = 'block';
        });
    }

    function actualizarEstadisticas() {
        const total = todosLosReportes.length;
        
        // FILTROS A etiqueta_normalizada
        const plastico = todosLosReportes.filter(r => r.etiqueta_normalizada === 'plastico').length;
        const noPlastico = todosLosReportes.filter(r => r.etiqueta_normalizada === 'noplastico').length;

        document.getElementById('totalReportes').textContent = total;
        document.getElementById('totalPlastico').textContent = plastico;
        document.getElementById('totalNoPlastico').textContent = noPlastico;
        document.getElementById('contador').textContent = `${total} reporte${total !== 1 ? 's' : ''}`;
    }

    function mostrarReportesEnMapa(reportes) {
        reportes.forEach(reporte => {
            // USAMOS reporte.longitud (min칰scula, clave unificada)
            if (!reporte.latitud || !reporte.longitud) return;

            // FILTRO A etiqueta_normalizada
            const esPlastico = reporte.etiqueta_normalizada === 'plastico'; 
            const icono = esPlastico ? iconoPlastico : iconoNoPlastico;

            const marcador = L.marker([reporte.latitud, reporte.longitud], { icon: icono }).addTo(mapa); 

            const fecha = formatearFecha(reporte.fecha || reporte.timestamp);
            
            const popupContent = `
                <div style="text-align: center;">
                    <img src="${reporte.foto_url || 'https://via.placeholder.com/200x150?text=Sin+foto'}" class="popup-imagen" alt="Foto del reporte" onerror="this.src='https://via.placeholder.com/200x150?text=Imagen+no+disponible'">
                    <h4>${esPlastico ? '游댮 Pl치stico' : '游릭 No Pl치stico'}</h4>
                    <p>游늰 ${fecha}</p>
                    <p>游늸 ${reporte.latitud.toFixed(5)}, ${reporte.longitud.toFixed(5)}</p>
                </div>
            `;
            
            marcador.bindPopup(popupContent);
            marcadores.push(marcador);
        });
    }

    function filtrar(tipo) {
        // Removemos la clase 'active' de todos los botones
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        
        // El evento.target es el bot칩n que se presion칩 (lo obtenemos por la funci칩n)
        const botonClicado = document.querySelector(`[onclick="filtrar('${tipo}')"]`);
        if (botonClicado) {
            botonClicado.classList.add('active');
        }

        let reportesFiltrados = tipo === 'todos' 
            ? todosLosReportes 
            : todosLosReportes.filter(r => {
                const tipoNorm = normalizarEtiqueta(tipo);
                return r.etiqueta_normalizada === tipoNorm;
            });

        marcadores.forEach(m => mapa.removeLayer(m));
        marcadores = [];
        mostrarReportesEnMapa(reportesFiltrados);
    }

    cargarReportes();
</script>
